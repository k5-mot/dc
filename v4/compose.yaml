services:

  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/public/favicon.ico:/usr/share/nginx/html/favicon.ico:ro
      - ./nginx/public/favicon.png:/usr/share/nginx/html/favicon.png:ro
    networks:
      - network-proxy


  # https://zenn.dev/mebiusbox/articles/a1f2ca3965bbb3
  # https://qiita.com/yama-ken/items/2a31b9061e4012213e4a
  openldap:
    image: osixia/openldap
    container_name: openldap
    environment:
      LDAP_ORGANISATION: "OpenLDAP"
      LDAP_DOMAIN: "openldap.com"
      LDAP_ADMIN_PASSWORD: "admin"
    networks:
      - network-proxy

  # 以下でログイン
  #   Login DN: "cn=admin,dc=openldap,dc=com"
  #   Password: "admin"
  openldap-ui:
    image: osixia/phpldapadmin
    container_name: openldap-ui
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: openldap-host
      PHPLDAPADMIN_HTTPS: false
    links:
      - openldap:openldap-host
    networks:
      - network-proxy


  # https://docs.portainer.io/start/install-ce/server/docker/linux
  portainer:
    container_name: portainer
    image: portainer/portainer-ce:2.20.3
    privileged: true
    volumes:
      - ./.volumes/portainer/data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks:
      - network-proxy


  # https://docs.gitlab.com/ee/install/docker.html
  gitlab:
    image: gitlab/gitlab-ee:16.10.3-ee.0
    container_name: gitlab
    restart: always
    shm_size: '256m'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Add any other gitlab.rb configuration here, each on its own line
        external_url 'http://192.168.11.2/gitlab'
        gitlab_rails['time_zone'] = 'Tokyo'
    volumes:
      - ./.volumes/gitlab/config:/etc/gitlab
      - ./.volumes/gitlab/logs:/var/log/gitlab
      - ./.volumes/gitlab/data:/var/opt/gitlab
    networks:
      - network-proxy
      - network-gitlab

  # https://docs.gitlab.com/runner/install/docker.html
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner
    restart: always
    volumes:
      - ./.volumes/gitlab-runner/config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - network-gitlab


  # https://github.com/jenkinsci/docker/blob/master/README.md
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    environment:
      - "JENKINS_OPTS=--prefix=/jenkins"
    volumes:
      - volume-jenkins:/var/jenkins_home
    networks:
      - network-proxy
      - network-jenkins

  jenkins-ssh:
    image: jenkins/ssh-agent
    container_name: jenkins-ssh
    networks:
      - network-jenkins


  redmine:
    # image: redmine:5.0.4-bullseye
    build:
      context: .
      dockerfile: ./redmine/Dockerfile
    container_name: redmine
    environment:
      REDMINE_DB_POSTGRES: redmine-db
      REDMINE_DB_DATABASE: redmine
      REDMINE_DB_USERNAME: redmine_user
      REDMINE_DB_PASSWORD: redmine_password
      REDMINE_SECRET_KEY_BASE: supersecretkey
      REDMINE_DB_PORT: 5432
    volumes:
      - volume-redmine:/usr/src/redmine/files
    networks:
      - network-proxy
      - network-redmine

  redmine-db:
    image: postgres:15.1-bullseye
    container_name: redmine-db
    environment:
      POSTGRES_DB: redmine
      POSTGRES_USER: redmine_user
      POSTGRES_PASSWORD: redmine_password
    volumes:
      - volume-redmine-db:/var/lib/postgresql/data
    networks:
      - network-redmine


  # https://gethomepage.dev/latest/configs/docker/#using-docker-socket-proxy
  dockerproxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    privileged: true
    container_name: dockerproxy
    environment:
      - CONTAINERS=1 # Allow access to viewing containers
      - SERVICES=0 # Allow access to viewing services (necessary when using Docker Swarm)
      - TASKS=0 # Allow access to viewing tasks (necessary when using Docker Swarm)
      - POST=0 # Disallow any POST operations (effectively read-only)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Mounted as read-only
    restart: unless-stopped
    networks:
      - network-homepage

  # https://github.com/gethomepage/homepage/
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    # build:
    #   context: ./homepage
      # dockerfile: ./homepage/Dockerfile
    container_name: homepage
    restart: unless-stopped
    privileged: true
    # environment:
    #   # use `id` command
    #   PUID: 1000
    #   PGID: 1000
    volumes:
      # Make sure your local config directory exists
      - ./homepage/config:/app/config
      # optional, for docker integrations
      # - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - network-proxy
      - network-homepage


  # https://coder.com/docs/code-server/latest/install#docker
  coder:
    image: lscr.io/linuxserver/code-server:latest
    container_name: coder
    restart: always
    privileged: true
    environment:
      - UID=1000
      - GID=1000
      - TZ=Asia/Tokyo
      - PASSWORD= #optional
      - HASHED_PASSWORD= #optional
      - SUDO_PASSWORD= #optional
      - SUDO_PASSWORD_HASH= #optional
      - PROXY_DOMAIN= #optional
    networks:
      - network-proxy
    volumes:
      - ./.volumes/coder/.local:/home/coder/.local
      - ./.volumes/coder/.config:/home/coder/.config
      - ./.volumes/coder/project:/home/coder/project


 # https://github.com/support-project/docker-knowledge/blob/master/docker-compose.yml
  knowledge:
    # image: koda/docker-knowledge:japanese
    build:
      context: .
      dockerfile: ./knowledge/Dockerfile
    container_name: knowledge
    volumes:
      - ./knowledge/custom_connection.xml:/root/.knowledge/custom_connection.xml
      - ./.volumes/knowledge:/root/.knowledge
    restart: always
    depends_on:
      - knowledge-db
    networks:
      - network-proxy
      - network-knowledge

  knowledge-db:
    image: postgres:9
    container_name: knowledge-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=admin123
      - POSTGRES_DB=knowledge_production
    volumes:
      # - ./volumes/initdb:/docker-entrypoint-initdb.d
      - ./.volumes/knowledge-db:/var/lib/postgresql/data
    restart: always
    networks:
      - network-knowledge


  nextcloud:
    container_name: nextcloud
    image: nextcloud
    volumes:
      - ./.volumes/nextcloud:/var/www/html
      - ./nextcloud/setup.sh:/root/setup.sh
    restart: always
    environment:
      - MYSQL_HOST=nextcloud-db
      - MYSQL_PASSWORD=nextcloud_pw
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud_user
    networks:
      - network-proxy
      - network-nextcloud

  nextcloud-db:
    container_name: nextcloud-db
    image: mariadb
    restart: always
    volumes:
      - ./.volumes/nextcloud-db:/var/lib/mysql
    environment:
      - MARIADB_ROOT_PASSWORD=nextcloud_root_pw
      - MARIADB_PASSWORD=nextcloud_pw
      - MARIADB_DATABASE=nextcloud
      - MARIADB_USER=nextcloud_user
    networks:
      - network-nextcloud


  # Initial Setup: username=admin, password=admin
  # DataSource: http://prometheus:9090
  # https://zenn.dev/aobaiwaki/articles/a612bf497c59ca
  # Import: https://grafana.com/grafana/dashboards/1860-node-exporter-full/
  # Import: https://grafana.com/grafana/dashboards/11600-docker-container/
  # https://github.com/rvva/nginx-prometheus-grafana/blob/main/docker-compose.yml
  grafana:
    image: grafana/grafana
    container_name: grafana
    restart: always
    networks:
      - network-proxy
      - network-grafana
    environment:
      - GF_SERVER_ROOT_URL=http://grafana:3000/grafana/
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - DS_PROMETHEUS=prometheus
    volumes:
      - ./grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
      - ./grafana/1860_rev37.json:/var/lib/grafana/dashboards/1860_rev37.json
      - ./grafana/11600_rev1.json:/var/lib/grafana/dashboards/11600_rev1.json
      - ./grafana/default.yaml:/etc/grafana/provisioning/dashboards/default.yaml

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yaml:/etc/prometheus/prometheus.yaml
    command: "--config.file=/etc/prometheus/prometheus.yaml"
    restart: always
    networks:
      - network-grafana

  exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: always
    networks:
      - network-grafana

  cadvisor:
    container_name: cadvisor
    image: gcr.io/cadvisor/cadvisor:latest
    # network_mode: host
    # ports:
    #   - 8080:8080
    volumes:
      - /:/rootfs
      - /var/run:/var/run
      - /sys:/sys
      - /var/lib/docker/:/var/lib/docker
      - /dev/disk/:/dev/disk
    privileged: true
    devices:
      - /dev/kmsg
    networks:
      - network-grafana


#  ollama:
#     volumes:
#       - ./ollama:/root/ollama
#       - volume-ollama:/root/.ollama
#     container_name: ollama
#     pull_policy: always
#     tty: true
#     restart: unless-stopped
#     image: ollama/ollama:latest
#     ports:
#       - 11434:11434
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # ollama-webui:
  #   # build:
  #   #   context: .
  #   #   args:
  #   #     OLLAMA_BASE_URL: '/ollama'
  #   #   dockerfile: Dockerfile
  #   image: ghcr.io/open-webui/open-webui:main
  #   container_name: ollama-webui
  #   volumes:
  #     - volume-ollama-webui:/app/backend/data
  #   depends_on:
  #     - ollama
  #   ports:
  #     - 3000:8080
  #   environment:
  #     - OLLAMA_BASE_URL=http://ollama:11434
  #     # - OPENAI_API_BASE_URL=http://litellm:4000/v1
  #     # - OPENAI_API_KEY=${LITELLM_API_KEY}
  #     # - WEBUI_SECRET_KEY=
  #     - WEBUI_AUTH=False
  #   extra_hosts:
  #     - host.docker.internal:host-gateway
  #   restart: unless-stopped


  # litellm:
  #   image: ghcr.io/berriai/litellm:main-latest
  #   environment:
  #     - MASTER_KEY=${LITELLM_API_KEY}
  #   ports:
  #     - 4000:8000
  #   volumes:
  #     - ./litellm/config.yaml:/app/config.yaml
  #   command: [ "--config", "/app/config.yaml", "--port", "8000" ]
  #   restart: unless-stopped


  # https://docs.requarks.io/install/docker
  wikijs:
    image: ghcr.io/requarks/wiki:2
    container_name: wikijs
    depends_on:
      - wikijs-db
    environment:
      DB_TYPE: postgres
      DB_HOST: wikijs-db
      DB_PORT: 5432
      DB_USER: wikijs
      DB_PASS: wikijsrocks
      DB_NAME: wiki
    restart: unless-stopped
    networks:
      # - network-proxy
      - network-wikijs
    ports:
      - 30010:3000

  wikijs-db:
    image: postgres:15-alpine
    container_name: wikijs-db
    environment:
      POSTGRES_DB: wiki
      POSTGRES_PASSWORD: wikijsrocks
      POSTGRES_USER: wikijs
    logging:
      driver: "none"
    restart: unless-stopped
    volumes:
      - volume-wikijs-db:/var/lib/postgresql/data
    networks:
      - network-wikijs


  docmost:
    image: docmost/docmost:latest
    container_name: docmost
    depends_on:
      - docmost-db
      - docmost-redis
    environment:
      APP_URL: 'http://localhost:30011/'
      APP_SECRET: '10f563cefb3a65fbcb5bd0b15e1932bc3a4949ef2b3d04af047d048bd5be2125'
      DATABASE_URL: 'postgresql://docmost:STRONG_DB_PASSWORD@docmost-db:5432/docmost?schema=public'
      REDIS_URL: 'redis://docmost-redis:6379'
    ports:
      - 30011:3000
    restart: unless-stopped
    volumes:
      - volume-docmost:/app/data/storage
    networks:
      # - network-proxy
      - network-docmost

  docmost-db:
    image: postgres:16-alpine
    container_name: docmost-db
    environment:
      POSTGRES_DB: docmost
      POSTGRES_USER: docmost
      POSTGRES_PASSWORD: STRONG_DB_PASSWORD
    restart: unless-stopped
    volumes:
      - volume-docmost-db:/var/lib/postgresql/data
    networks:
      - network-docmost

  docmost-redis:
    image: redis:7.2-alpine
    container_name: docmost-redis
    restart: unless-stopped
    volumes:
      - volume-docmost-redis:/data
    networks:
      - network-docmost


networks:
  network-proxy:
    name: network-proxy
    driver: bridge
  network-gitlab:
    name: network-gitlab
  network-redmine:
    name: network-redmine
  network-homepage:
    name: network-homepage
  network-jenkins:
    name: network-jenkins
  network-knowledge:
    name: network-knowledge
  network-wikijs:
    name: network-wikijs
  network-nextcloud:
    name: network-nextcloud
  network-grafana:
    name: network-grafana
  network-docmost:
    name: network-docmost
  # network-ollama:
  #   name: network-ollama


volumes:
  volume-redmine:
    name: volume-redmine
  volume-redmine-db:
    name: volume-redmine-db
  volume-jenkins:
    name: volume-jenkins
  volume-wikijs-db:
    name: volume-wikijs-db
  volume-docmost:
    name: volume-docmost
  volume-docmost-db:
    name: volume-docmost-db
  volume-docmost-redis:
    name: volume-docmost-redis
  # volume-ollama:
  #   name: volume-ollama
  # volume-ollama-webui:
  #   name: volume-ollama-webui
